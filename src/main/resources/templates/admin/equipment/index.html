<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¾å¤‡ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
<nav class="admin-nav">
    <div class="nav-brand">è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</div>
    <div class="nav-links">
        <a href="/admin">ç®¡ç†é¦–é¡µ</a>
        <a href="/admin/users">ç”¨æˆ·ç®¡ç†</a>
        <a href="/admin/equipment">è®¾å¤‡ç®¡ç†</a>
        <a href="/admin/transfers">è®¾å¤‡è°ƒç”¨</a>
        <a href="/admin/locations">ä½ç½®ç®¡ç†</a>
        <a href="/admin/categories">åˆ†ç±»ç®¡ç†</a>
        <a href="/admin/suppliers">ä¾›åº”å•†ç®¡ç†</a>
    </div>
</nav>

<div class="admin-container">
    <div class="page-header">
        <h1>è®¾å¤‡ç®¡ç†</h1>
        <button class="btn btn-primary" onclick="reloadAll()">
            <span class="icon">â†»</span> åˆ·æ–°æ•°æ®
        </button>
    </div>

    <div id="msg" class="alert hidden"></div>

    <div class="card">
        <div class="card-header">
            <h2>è®¾å¤‡åˆ—è¡¨</h2>
            <div class="card-actions">
                <button class="btn btn-secondary" onclick="exportCsv()">
                    <span class="icon">ğŸ“Š</span> å¯¼å‡º CSV
                </button>
            </div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-group">
                <label>çŠ¶æ€ç­›é€‰</label>
                <select id="filterStatus" class="form-select" onchange="onFilterChanged()"></select>
            </div>
            
            <div class="filter-group">
                <label>åˆ†ç±»ç­›é€‰</label>
                <select id="filterCategoryId" class="form-select" onchange="onFilterChanged()"></select>
            </div>
            
            <div class="filter-group">
                <label>æœç´¢</label>
                <div class="search-input">
                    <input id="searchKeyword" type="text" placeholder="åç§°/å‹å·/å“ç‰Œ/åºåˆ—å·/èµ„äº§ç¼–å·" />
                    <button class="btn btn-sm" onclick="onSearch()">æœç´¢</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearFilter()">æ¸…ç©º</button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table id="equipmentTable" class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>å“ç‰Œ</th>
                        <th>å‹å·</th>
                        <th>æ•°é‡</th>
                        <th>åˆ†ç±»</th>
                        <th>ä¾›åº”å•†</th>
                        <th>ä½ç½®</th>
                        <th>ä¿ç®¡äºº</th>
                        <th>é‡‡è´­æ—¥æœŸ</th>
                        <th>æœ€è¿‘æ“ä½œ</th>
                        <th>æ“ä½œæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="pagination-bar">
            <div class="pagination-info">
                <span id="pageInfo">ç¬¬ 1/1 é¡µï¼Œå…± 0 æ¡</span>
            </div>
            <div class="pagination-controls">
                <div class="page-size">
                    <label>æ¯é¡µæ˜¾ç¤º</label>
                    <select id="pageSize" onchange="onPageSizeChanged()">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="pagination-buttons">
                    <button class="btn btn-sm" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                    <button class="btn btn-sm" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="card">
            <div class="card-header">
                <h2>æ–°å¢è®¾å¤‡</h2>
            </div>
            <div class="card-body">
                <form id="createForm" onsubmit="return submitCreate(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">è®¾å¤‡åç§°</label>
                            <input type="text" id="name" required placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°">
                        </div>
                        <div class="form-group">
                            <label class="required">è®¾å¤‡çŠ¶æ€</label>
                            <select id="status" required></select>
                        </div>
                        <div class="form-group">
                            <label>è®¾å¤‡åˆ†ç±»</label>
                            <select id="categoryId"></select>
                        </div>
                        <div class="form-group">
                            <label>ä¾›åº”å•†</label>
                            <select id="supplierId"></select>
                        </div>
                        <div class="form-group">
                            <label>å“ç‰Œ</label>
                            <input type="text" id="brand" placeholder="å¯é€‰">
                        </div>
                        <div class="form-group">
                            <label>å‹å·</label>
                            <input type="text" id="model" placeholder="å¯é€‰">
                        </div>
                        <div class="form-group">
                            <label>æ•°é‡</label>
                            <input type="number" id="quantity" min="0" value="1">
                        </div>
                        <div class="form-group">
                            <label>å­˜æ”¾ä½ç½®</label>
                            <select id="locationId"></select>
                        </div>
                        <div class="form-group">
                            <label>ä¿ç®¡äºº</label>
                            <select id="keeperId"></select>
                        </div>
                        <div class="form-group">
                            <label>é‡‡è´­æ—¥æœŸ</label>
                            <input type="date" id="purchaseDate">
                        </div>
                        <div class="form-group">
                            <label>å¤‡æ³¨</label>
                            <input type="text" id="remarks" placeholder="å¯é€‰">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">æ·»åŠ è®¾å¤‡</button>
                        <button type="reset" class="btn btn-secondary">é‡ç½®</button>
                    </div>
                </form>
                <div id="createMsg" class="alert hidden"></div>
            </div>
        </div>

<h3 style="margin-top:16px;">æœ€è¿‘ç›˜åº“è®°å½•ï¼ˆTop 10ï¼‰</h3>
<div id="recentInvMsg" class="hidden"></div>
<table id="recentInventoryTable" style="margin-top:8px;">
  <thead>
    <tr>
      <th>è®°å½•ID</th>
      <th>åˆ›å»ºæ—¶é—´</th>
      <th>æ¥æº</th>
      <th>å¤‡æ³¨</th>
      <th>è°ƒæ•´åæ•°é‡</th>
      <th>è°ƒæ•´åŸå› </th>
      <th>ç™»è®°äºº</th>
    </tr>
  </thead>
  <tbody></tbody>
  <caption style="caption-side: bottom; text-align:left; font-size:12px; color:#666;">è¯´æ˜ï¼šç™»è®°ç›˜åº“åå°†è‡ªåŠ¨åˆ·æ–°è¯¥åˆ—è¡¨ï¼›ç™»è®°äººæ¥æºäºé’ˆå¯¹ InventoryRecord çš„ CREATE æ“ä½œæ—¥å¿—ã€‚</caption>
</table>

<h2 style="margin-top:24px;">ç¼–è¾‘è®¾å¤‡</h2>
<form id="editForm" onsubmit="return submitUpdate(event)">
  <div class="form-grid">
    <div class="form-item">
      <label>è®¾å¤‡ID</label>
      <input type="number" id="editId" readonly placeholder="é€‰æ‹©ä¸€è¡Œæˆ–ç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®">
    </div>
    <div class="form-item">
      <label>åç§°ï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="editName" required>
    </div>
    <div class="form-item">
      <label>çŠ¶æ€ï¼ˆå¿…å¡«ï¼‰</label>
      <select id="editStatus" required></select>
    </div>
    <div class="form-item">
      <label>åˆ†ç±»</label>
      <select id="editCategoryId"></select>
    </div>
        <div class="form-item">
          <label>ä¾›åº”å•†ID</label>
          <select id="editSupplierId"></select>
        </div>
    <div class="form-item">
      <label>å“ç‰Œ</label>
      <input type="text" id="editBrand">
    </div>
    <div class="form-item">
      <label>å‹å·</label>
      <input type="text" id="editModel">
    </div>
    <div class="form-item">
      <label>æ•°é‡</label>
      <input type="number" id="editQuantity" min="0" placeholder="ä¸å¡«åˆ™ä¿æŒåŸå€¼">
    </div>
        <div class="form-item">
          <label>ä½ç½®ID</label>
          <select id="editLocationId"></select>
        </div>
        <div class="form-item">
          <label>ä¿ç®¡äººID</label>
          <select id="editKeeperId"></select>
        </div>
    <div class="form-item">
      <label>é‡‡è´­æ—¥æœŸ</label>
      <input type="date" id="editPurchaseDate">
    </div>
    <div class="form-item">
      <label>å¤‡æ³¨</label>
      <input type="text" id="editRemarks">
    </div>
  </div>
  <div class="actions">
    <button type="submit">ä¿å­˜æ›´æ–°</button>
    <button type="button" class="danger" onclick="confirmDelete()">åˆ é™¤è¯¥è®¾å¤‡</button>
  </div>
  <div id="editMsg" class="hidden"></div>
  <div style="margin-top:8px; font-size:12px; color:#888;">æ›´æ–°æ¥å£ï¼šPUT /api/equipment/{id}ï¼ˆEquipmentDTOï¼‰ï¼›åˆ é™¤æ¥å£ï¼šDELETE /api/equipment/{id}</div>
</form>

<script>
const API_BASE = '/api';
// ç¼“å­˜å­—å…¸ï¼Œç”¨äºåœ¨è¡¨æ ¼ä¸­é€šè¿‡IDæ˜¾ç¤ºåç§°
const categoriesMap = new Map();
const suppliersMap = new Map();
const locationsMap = new Map();
const keepersMap = new Map();

function showMsg(text, ok = true) {
  const el = document.getElementById('msg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 4000);
}

function setCreateMsg(text, ok = true) {
  const el = document.getElementById('createMsg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5000);
}

async function fetchJson(url, options = {}) {
  const resp = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`HTTP ${resp.status}: ${txt}`);
  }
  const ct = resp.headers.get('content-type') || '';
  if (ct.includes('application/json')) return resp.json();
  return resp.text();
}

function toDateTimeLocal(dateStr) {
  if (!dateStr) return '';
  try { return new Date(dateStr).toLocaleString(); } catch(e) { return dateStr; }
}

// æ“ä½œæ—¥å¿—ç¼“å­˜ä¸æŸ¥è¯¢ï¼ˆè®¾å¤‡æœ€è¿‘æ“ä½œäºº/æ—¶é—´ï¼‰
const latestOpCache = new Map(); // key: `${type}:${id}:${action||''}`
async function fetchLatestOperationLog(entityType, entityId, action) {
  const key = `${entityType}:${entityId}:${action || ''}`;
  if (latestOpCache.has(key)) return latestOpCache.get(key);
  try {
    const params = new URLSearchParams();
    params.set('entityType', entityType);
    params.set('entityId', String(entityId));
    if (action) params.set('action', action);
    const log = await fetchJson(`${API_BASE}/operation-logs/latest?` + params.toString());
    latestOpCache.set(key, log || null);
    return log || null;
  } catch (err) {
    latestOpCache.set(key, null);
    return null;
  }
}

async function renderEquipmentTable(list) {
  const tbody = document.querySelector('#equipmentTable tbody');
  tbody.innerHTML = '';
  for (const e of list) {
    const tr = document.createElement('tr');
    const categoryName = categoriesMap.get(e.categoryId) || e.categoryId || '';
    const supplierName = suppliersMap.get(e.supplierId) || e.supplierId || '';
    const locationName = locationsMap.get(e.locationId) || e.locationId || '';
    const keeperName = keepersMap.get(e.keeperId) || e.keeperId || '';
    const latestLog = await fetchLatestOperationLog('Equipment', e.id, null);
    const latestActor = latestLog && latestLog.actor ? latestLog.actor : '';
    const latestTime = latestLog && latestLog.createdAt ? toDateTimeLocal(latestLog.createdAt) : '';
    tr.innerHTML = `
      <td>${e.id ?? ''}</td>
      <td>${e.name ?? ''}</td>
      <td>${e.status ?? ''}</td>
      <td>${e.brand ?? ''}</td>
      <td>${e.model ?? ''}</td>
      <td>${e.quantity ?? ''}</td>
      <td>${categoryName}</td>
      <td>${supplierName}</td>
      <td>${locationName}</td>
      <td>${keeperName}</td>
      <td>${e.purchaseDate ?? ''}</td>
      <td>${latestActor}</td>
      <td>${latestTime}</td>
      <td>
        <button onclick="invokeEquipment(${encodeId(e.id)})">è°ƒç”¨</button>
        <button onclick="setEditForm(${encodeId(e.id)})">ç¼–è¾‘</button>
        <button onclick="createInventoryRecord(${encodeId(e.id)})">ç™»è®°ç›˜åº“</button>
        <button class="danger" onclick="deleteEquipment(${encodeId(e.id)})">åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

let currentPage = 0;
let pageSize = 10;
let totalPages = 0;
let totalElements = 0;
const filters = { status: null, categoryId: null, keyword: null, supplierId: null, locationId: null, keeperId: null };

function updatePageInfo() {
  const info = document.getElementById('pageInfo');
  info.textContent = `ç¬¬ ${Math.min(currentPage + 1, Math.max(totalPages, 1))}/${Math.max(totalPages, 1)} é¡µï¼Œå…± ${totalElements} æ¡`;
}

async function loadEquipment() {
  // ä½¿ç”¨ /api/equipment/query è¿›è¡Œåˆ†é¡µä¸ç­›é€‰
  try {
    const params = new URLSearchParams();
    params.set('page', String(currentPage));
    params.set('size', String(pageSize));
    if (filters.status) params.set('status', filters.status);
    if (filters.categoryId) params.set('categoryId', String(filters.categoryId));
    if (filters.keyword && filters.keyword.trim() !== '') params.set('keyword', filters.keyword.trim());
    if (filters.supplierId) params.set('supplierId', String(filters.supplierId));
    if (filters.locationId) params.set('locationId', String(filters.locationId));
    if (filters.keeperId) params.set('keeperId', String(filters.keeperId));
    const page = await fetchJson(`${API_BASE}/equipment/query?` + params.toString());
    const list = page.content || [];
    totalPages = page.totalPages ?? 1;
    totalElements = page.totalElements ?? list.length;
    await renderEquipmentTable(list);
    updatePageInfo();
    showMsg(`å·²åŠ è½½è®¾å¤‡ ${list.length} æ¡ï¼ˆå½“å‰é¡µï¼‰`);
  } catch (err) {
    console.error(err);
    showMsg(`åŠ è½½è®¾å¤‡å¤±è´¥ï¼š${err.message}`, false);
  }
}

async function loadCategories() {
  const sel = document.getElementById('categoryId');
  sel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list = await fetchJson(`${API_BASE}/equipment-categories`);
    list.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.name} (ID=${c.id})`;
      sel.appendChild(opt);
      categoriesMap.set(c.id, c.name);
    });
  } catch (err) {
    console.warn('åˆ†ç±»åŠ è½½å¤±è´¥ï¼š', err);
  }
  // åŒæ­¥ç¼–è¾‘è¡¨å•çš„åˆ†ç±»ä¸‹æ‹‰
  const editSel = document.getElementById('editCategoryId');
  const cacheVal = editSel.value;
  editSel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list2 = await fetchJson(`${API_BASE}/equipment-categories`);
    list2.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.name} (ID=${c.id})`;
      editSel.appendChild(opt);
      categoriesMap.set(c.id, c.name);
    });
    editSel.value = cacheVal;
  } catch (err) {
    console.warn('ç¼–è¾‘è¡¨å•åˆ†ç±»ä¸‹æ‹‰åŠ è½½å¤±è´¥ï¼š', err);
  }
  // åŒæ­¥ç­›é€‰ä¸‹æ‹‰
  const filterSel = document.getElementById('filterCategoryId');
  const cacheFilterVal = filterSel.value;
  filterSel.innerHTML = '<option value="">ï¼ˆå…¨éƒ¨ï¼‰</option>';
  categoriesMap.forEach((name, id) => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = name + ` (ID=${id})`;
    filterSel.appendChild(opt);
  });
  filterSel.value = cacheFilterVal || '';
}

async function loadSuppliers() {
  const sel = document.getElementById('supplierId');
  sel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list = await fetchJson(`${API_BASE}/suppliers`);
    list.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.name} (ID=${s.id})`;
      sel.appendChild(opt);
      suppliersMap.set(s.id, s.name);
    });
  } catch (err) {
    console.warn('ä¾›åº”å•†åŠ è½½å¤±è´¥ï¼š', err);
  }
  const editSel = document.getElementById('editSupplierId');
  const cacheVal = editSel.value;
  editSel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list2 = await fetchJson(`${API_BASE}/suppliers`);
    list2.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.name} (ID=${s.id})`;
      editSel.appendChild(opt);
      suppliersMap.set(s.id, s.name);
    });
    editSel.value = cacheVal;
  } catch (err) {
    console.warn('ç¼–è¾‘è¡¨å•ä¾›åº”å•†ä¸‹æ‹‰åŠ è½½å¤±è´¥ï¼š', err);
  }
}

async function loadLocations() {
  const sel = document.getElementById('locationId');
  sel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list = await fetchJson(`${API_BASE}/locations`);
    list.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l.id;
      opt.textContent = `${l.name} (ID=${l.id})`;
      sel.appendChild(opt);
      locationsMap.set(l.id, l.name);
    });
  } catch (err) {
    console.warn('ä½ç½®åŠ è½½å¤±è´¥ï¼š', err);
  }
  const editSel = document.getElementById('editLocationId');
  const cacheVal = editSel.value;
  editSel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list2 = await fetchJson(`${API_BASE}/locations`);
    list2.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l.id;
      opt.textContent = `${l.name} (ID=${l.id})`;
      editSel.appendChild(opt);
      locationsMap.set(l.id, l.name);
    });
    editSel.value = cacheVal;
  } catch (err) {
    console.warn('ç¼–è¾‘è¡¨å•ä½ç½®ä¸‹æ‹‰åŠ è½½å¤±è´¥ï¼š', err);
  }
}

async function loadKeepers() {
  const sel = document.getElementById('keeperId');
  sel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list = await fetchJson(`${API_BASE}/admin/users`);
    list.forEach(u => {
      const name = u.displayName || u.username || `ç”¨æˆ·${u.id}`;
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = `${name} (ID=${u.id})`;
      sel.appendChild(opt);
      keepersMap.set(u.id, name);
    });
  } catch (err) {
    console.warn('ä¿ç®¡äººåŠ è½½å¤±è´¥ï¼š', err);
  }
  const editSel = document.getElementById('editKeeperId');
  const cacheVal = editSel.value;
  editSel.innerHTML = '<option value="">ï¼ˆæœªé€‰æ‹©ï¼‰</option>';
  try {
    const list2 = await fetchJson(`${API_BASE}/admin/users`);
    list2.forEach(u => {
      const name = u.displayName || u.username || `ç”¨æˆ·${u.id}`;
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = `${name} (ID=${u.id})`;
      editSel.appendChild(opt);
      keepersMap.set(u.id, name);
    });
    editSel.value = cacheVal;
  } catch (err) {
    console.warn('ç¼–è¾‘è¡¨å•ä¿ç®¡äººä¸‹æ‹‰åŠ è½½å¤±è´¥ï¼š', err);
  }
}

function initStatusOptions() {
  const statuses = ['åœ¨ç”¨','é—²ç½®','å€Ÿç”¨ä¸­','ç»´ä¿®ä¸­','æŠ¥åºŸ'];
  const sel = document.getElementById('status');
  statuses.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  const editSel = document.getElementById('editStatus');
  statuses.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    editSel.appendChild(opt);
  });
  // è¿‡æ»¤ä¸‹æ‹‰
  const filterSel = document.getElementById('filterStatus');
  filterSel.innerHTML = '<option value="">ï¼ˆå…¨éƒ¨ï¼‰</option>';
  statuses.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    filterSel.appendChild(opt);
  });
}

async function submitCreate(ev) {
  ev.preventDefault();
  const payload = {
    name: document.getElementById('name').value.trim(),
    status: document.getElementById('status').value,
    categoryId: parseNullableInt(document.getElementById('categoryId').value),
    supplierId: parseNullableInt(document.getElementById('supplierId').value),
    brand: nullIfEmpty(document.getElementById('brand').value),
    model: nullIfEmpty(document.getElementById('model').value),
    quantity: (function(){ const v = parseNullableInt(document.getElementById('quantity').value); return v != null ? v : 1; })(),
    locationId: parseNullableInt(document.getElementById('locationId').value),
    keeperId: parseNullableInt(document.getElementById('keeperId').value),
    purchaseDate: nullIfEmpty(document.getElementById('purchaseDate').value),
    remarks: nullIfEmpty(document.getElementById('remarks').value)
  };
  try {
    const created = await fetchJson(`${API_BASE}/equipment`, { method: 'POST', body: JSON.stringify(payload) });
    setCreateMsg(`æ–°å¢æˆåŠŸï¼ŒID=${created.id}`);
    document.getElementById('createForm').reset();
    await loadEquipment();
  } catch (err) {
    console.error(err);
    setCreateMsg(`æ–°å¢å¤±è´¥ï¼š${err.message}`, false);
  }
}

function setEditFormByData(e) {
  document.getElementById('editId').value = e.id ?? '';
  document.getElementById('editName').value = e.name ?? '';
  document.getElementById('editStatus').value = e.status ?? '';
  document.getElementById('editCategoryId').value = e.categoryId ?? '';
  document.getElementById('editSupplierId').value = e.supplierId ?? '';
  document.getElementById('editBrand').value = e.brand ?? '';
  document.getElementById('editModel').value = e.model ?? '';
  document.getElementById('editQuantity').value = (typeof e.quantity === 'number') ? e.quantity : '';
  document.getElementById('editLocationId').value = e.locationId ?? '';
  document.getElementById('editKeeperId').value = e.keeperId ?? '';
  document.getElementById('editPurchaseDate').value = e.purchaseDate ?? '';
  document.getElementById('editRemarks').value = e.remarks ?? '';
}

function encodeId(id) { return typeof id === 'number' ? id : (id ?? ''); }

async function setEditForm(id) {
  if (!id) { setEditMsg('è¯·å…ˆé€‰æ‹©æœ‰æ•ˆçš„è®¾å¤‡ID', false); return; }
  try {
    const e = await fetchJson(`${API_BASE}/equipment/${id}`);
    setEditFormByData(e);
    setEditMsg('å·²è½½å…¥è®¾å¤‡æ•°æ®ï¼Œå¯ç¼–è¾‘åä¿å­˜');
    // åŠ è½½æœ€è¿‘ç›˜åº“è®°å½•
    await loadRecentInventoryRecords(e.id);
  } catch (err) {
    console.error(err);
    setEditMsg(`è½½å…¥è®¾å¤‡å¤±è´¥ï¼š${err.message}`, false);
  }
}

function setEditMsg(text, ok = true) {
  const el = document.getElementById('editMsg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5000);
}

async function submitUpdate(ev) {
  ev.preventDefault();
  const id = parseNullableInt(document.getElementById('editId').value);
  if (!id) { setEditMsg('ç¼ºå°‘è®¾å¤‡IDï¼Œè¯·å…ˆåœ¨åˆ—è¡¨ç‚¹å‡»â€œç¼–è¾‘â€åŠ è½½æ•°æ®', false); return; }
  const payload = {
    name: document.getElementById('editName').value.trim(),
    status: document.getElementById('editStatus').value,
    categoryId: parseNullableInt(document.getElementById('editCategoryId').value),
    supplierId: parseNullableInt(document.getElementById('editSupplierId').value),
    brand: nullIfEmpty(document.getElementById('editBrand').value),
    model: nullIfEmpty(document.getElementById('editModel').value),
    quantity: parseNullableInt(document.getElementById('editQuantity').value),
    locationId: parseNullableInt(document.getElementById('editLocationId').value),
    keeperId: parseNullableInt(document.getElementById('editKeeperId').value),
    purchaseDate: nullIfEmpty(document.getElementById('editPurchaseDate').value),
    remarks: nullIfEmpty(document.getElementById('editRemarks').value)
  };
  try {
    const updated = await fetchJson(`${API_BASE}/equipment/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
    setEditMsg(`æ›´æ–°æˆåŠŸï¼ŒID=${updated.id}`);
    await loadEquipment();
  } catch (err) {
    console.error(err);
    setEditMsg(`æ›´æ–°å¤±è´¥ï¼š${err.message}`, false);
  }
}

async function deleteEquipment(id) {
  if (!id) { setEditMsg('ç¼ºå°‘è®¾å¤‡ID', false); return; }
  if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è®¾å¤‡ï¼Ÿ')) return;
  try {
    const resp = await fetch(`${API_BASE}/equipment/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error(await resp.text());
    setEditMsg('åˆ é™¤æˆåŠŸ');
    await loadEquipment();
  } catch (err) {
    console.error(err);
    setEditMsg(`åˆ é™¤å¤±è´¥ï¼š${err.message}`, false);
  }
}

async function filterByStatus() {
  const s = document.getElementById('filterStatus').value;
  filters.status = s || null;
  currentPage = 0;
  await loadEquipment();
}

async function clearFilter() {
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterCategoryId').value = '';
  document.getElementById('searchKeyword').value = '';
  filters.status = null;
  filters.categoryId = null;
  filters.keyword = null;
  filters.supplierId = null;
  filters.locationId = null;
  filters.keeperId = null;
  currentPage = 0;
  await loadEquipment();
}

function parseNullableInt(val) {
  if (!val || val === '') return null;
  const n = parseInt(val, 10);
  return isNaN(n) ? null : n;
}

function nullIfEmpty(val) {
  return val && val.trim() !== '' ? val.trim() : null;
}

async function reloadAll() {
  // å…ˆåŠ è½½å„ä¸‹æ‹‰ä¸åç§°æ˜ å°„ï¼Œå†åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼Œç¡®ä¿è¡¨æ ¼èƒ½æ˜¾ç¤ºåç§°è€Œä¸æ˜¯ID
  await Promise.all([loadCategories(), loadSuppliers(), loadLocations(), loadKeepers()]);
  await loadEquipment();
}

function onFilterChanged() {
  const catVal = document.getElementById('filterCategoryId').value;
  filters.categoryId = catVal ? parseNullableInt(catVal) : null;
  const statusVal = document.getElementById('filterStatus').value;
  filters.status = statusVal || null;
  currentPage = 0;
  loadEquipment();
}

function onSearch() {
  const kw = document.getElementById('searchKeyword').value || '';
  filters.keyword = kw.trim() !== '' ? kw.trim() : null;
  currentPage = 0;
  loadEquipment();
}

function onPageSizeChanged() {
  pageSize = parseNullableInt(document.getElementById('pageSize').value) || 10;
  currentPage = 0;
  loadEquipment();
}

function nextPage() {
  if (currentPage + 1 < totalPages) {
    currentPage += 1;
    loadEquipment();
  }
}

function prevPage() {
  if (currentPage > 0) {
    currentPage -= 1;
    loadEquipment();
  }
}

async function createInventoryRecord(equipmentId) {
  if (!equipmentId) { showMsg('æ— æ•ˆçš„è®¾å¤‡IDï¼Œæ— æ³•ç™»è®°ç›˜åº“', false); return; }
  const source = prompt('ç›˜åº“æ¥æºï¼ˆä¾‹å¦‚ï¼šå®ç›˜/ç³»ç»Ÿ/æŠ½æŸ¥ï¼‰ï¼Œå¯ç•™ç©º');
  const note = prompt('ç›˜åº“å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ï¼šæ•°é‡æ ¸å¯¹ï¼Œä½ç½®ç¡®è®¤ç­‰ï¼‰');
  // æ˜¯å¦è°ƒæ•´æ•°é‡
  const adjust = confirm('æ˜¯å¦éœ€è¦è°ƒæ•´æ•°é‡ï¼Ÿ\né€‰æ‹©â€œç¡®å®šâ€è¡¨ç¤ºæœ¬æ¬¡ç›˜åº“è¦è°ƒæ•´æ•°é‡');
  let newQuantity = null;
  let adjustReason = null;
  if (adjust) {
    const newQStr = prompt('è¯·è¾“å…¥è°ƒæ•´åçš„æ•°é‡ï¼ˆéè´Ÿæ•´æ•°ï¼‰');
    if (newQStr == null) { showMsg('å·²å–æ¶ˆæ•°é‡è°ƒæ•´'); return; }
    const parsed = parseInt(newQStr, 10);
    if (isNaN(parsed) || parsed < 0) { showMsg('æ•°é‡è¾“å…¥æ— æ•ˆï¼šè¯·å¡«å†™éè´Ÿæ•´æ•°', false); return; }
    newQuantity = parsed;
    adjustReason = prompt('è¯·è¾“å…¥æ•°é‡å˜æ›´åŸå› ï¼ˆå¿…å¡«ï¼‰');
    if (!adjustReason || adjustReason.trim() === '') { showMsg('å˜æ›´åŸå› ä¸ºå¿…å¡«é¡¹', false); return; }
  }
  const payload = {
    source: source && source.trim() !== '' ? source.trim() : null,
    note: note && note.trim() !== '' ? note.trim() : null,
    adjustQuantity: adjust ? true : false,
    newQuantity: newQuantity,
    adjustReason: adjustReason && adjustReason.trim() !== '' ? adjustReason.trim() : null
  };
  try {
    const created = await fetchJson(`${API_BASE}/inventory-records/${equipmentId}`, { method: 'POST', body: JSON.stringify(payload) });
    showMsg(`ç›˜åº“ç™»è®°æˆåŠŸï¼šè®°å½•ID=${created.id}`);
    // åˆ·æ–°æœ€è¿‘ç›˜åº“åˆ—è¡¨ & åˆ·æ–°è®¾å¤‡è¡¨æ ¼ï¼ˆä»¥ä¾¿æ•°é‡å˜åŒ–ç«‹å³å¯è§ï¼‰
    await loadRecentInventoryRecords(equipmentId);
    await loadEquipment();
  } catch (err) {
    console.error(err);
    showMsg('ç›˜åº“ç™»è®°å¤±è´¥ï¼š' + err.message, false);
  }
}

// åŠ è½½å¹¶æ¸²æŸ“æœ€è¿‘ç›˜åº“è®°å½•ï¼ˆé»˜è®¤ Top 10ï¼‰
async function loadRecentInventoryRecords(equipmentId) {
  const tbody = document.querySelector('#recentInventoryTable tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#666;">åŠ è½½ä¸­...</td></tr>';
  try {
    const params = new URLSearchParams();
    params.set('equipmentId', String(equipmentId));
    params.set('limit', '10');
    const list = await fetchJson(`${API_BASE}/inventory-records?` + params.toString());
    await renderRecentInventoryTable(list || []);
    const el = document.getElementById('recentInvMsg');
    el.className = 'success';
    el.textContent = `å·²åŠ è½½æœ€è¿‘ç›˜åº“è®°å½• ${list.length} æ¡`;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 3000);
  } catch (err) {
    console.error(err);
    const el = document.getElementById('recentInvMsg');
    el.className = 'error';
    el.textContent = 'åŠ è½½æœ€è¿‘ç›˜åº“è®°å½•å¤±è´¥ï¼š' + err.message;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
  }
}

async function renderRecentInventoryTable(records) {
  const tbody = document.querySelector('#recentInventoryTable tbody');
  tbody.innerHTML = '';
  if (!records || records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">æš‚æ— ç›˜åº“è®°å½•</td></tr>';
    return;
  }
  // å¹¶è¡Œè·å–æ¯æ¡è®°å½•çš„åˆ›å»ºæ“ä½œè€…
  const actorPromises = records.map(r => fetchLatestOperationLog('InventoryRecord', r.id, 'CREATE'));
  const logs = await Promise.all(actorPromises);
  for (let i = 0; i < records.length; i++) {
    const r = records[i];
    const log = logs[i];
    const actor = log && log.actor ? log.actor : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id ?? ''}</td>
      <td>${r.createdAt ? toDateTimeLocal(r.createdAt) : ''}</td>
      <td>${r.source ?? ''}</td>
      <td>${r.note ?? ''}</td>
      <td>${typeof r.adjustAfterQuantity === 'number' ? r.adjustAfterQuantity : ''}</td>
      <td>${r.adjustReason ?? ''}</td>
      <td>${actor}</td>
    `;
    tbody.appendChild(tr);
  }
}

async function invokeEquipment(equipmentId) {
  if (!equipmentId) { showMsg('æ— æ•ˆçš„è®¾å¤‡IDï¼Œæ— æ³•è°ƒç”¨', false); return; }
  
  // Check if equipment is available for transfer
  try {
    const equipment = await fetchJson(`${API_BASE}/equipment/${equipmentId}`);
    if (equipment.status === 'å€Ÿç”¨ä¸­' || equipment.status === 'ç»´ä¿®ä¸­' || equipment.status === 'æŠ¥åºŸ') {
      showMsg(`è®¾å¤‡å½“å‰çŠ¶æ€ä¸º"${equipment.status}"ï¼Œæ— æ³•è°ƒç”¨`, false);
      return;
    }
    
    // Redirect to transfer creation page with pre-filled equipment
    window.location.href = `/admin/transfers?equipmentId=${equipmentId}`;
  } catch (err) {
    console.error(err);
    showMsg(`æ£€æŸ¥è®¾å¤‡çŠ¶æ€å¤±è´¥ï¼š${err.message}`, false);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  initStatusOptions();
  reloadAll();
});

// å¯¼å‡ºå½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„è®¾å¤‡åˆ—è¡¨ä¸º CSV
function exportCsv() {
  try {
    const params = new URLSearchParams();
    if (filters.status) params.set('status', filters.status);
    if (filters.categoryId) params.set('categoryId', String(filters.categoryId));
    if (filters.keyword) params.set('keyword', filters.keyword);
    if (filters.supplierId) params.set('supplierId', String(filters.supplierId));
    if (filters.locationId) params.set('locationId', String(filters.locationId));
    if (filters.keeperId) params.set('keeperId', String(filters.keeperId));
    const url = `${API_BASE}/equipment/export?` + params.toString();
    // åœ¨æ–°çª—å£æ‰“å¼€ä»¥è§¦å‘ä¸‹è½½
    window.open(url, '_blank');
  } catch (err) {
    console.error(err);
    showMsg('å¯¼å‡ºå¤±è´¥ï¼š' + err.message, false);
  }
}
</script>

</body>
</html>