<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>维修管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { font-size: 20px; }
        .toolbar { margin-bottom: 16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f6f6f6; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .form-item { display: flex; flex-direction: column; }
        .actions { margin-top: 12px; }
        .success { color: #0a8; }
        .error { color: #d33; }
        .hidden { display: none; }
        .card { border:1px solid #eee; border-radius: 6px; padding: 14px; margin-bottom: 14px; }
    </style>
</head>
<body>
<h1>维修管理</h1>

<div class="toolbar">
    <a href="/admin" style="margin-right:auto;">返回管理首页</a>
    <button onclick="reloadAll()">刷新数据</button>
    <span id="msg" class="hidden"></span>
    <div style="width:100%; font-size: 12px; color:#666;">提示：开始/完成维修使用设备流程接口：POST /api/equipment/{id}/workflow/maintenance/start 与 /complete</div>
    <div style="width:100%; font-size: 12px; color:#666;">统计接口：GET /api/maintenances/stats?start=...&end=...</div>
    <div style="width:100%; font-size: 12px; color:#666;">列表接口：GET /api/maintenances?equipmentId=&ongoingOnly=&startFrom=&startTo=&page=&size=</div>
  </div>

<div class="card">
  <h2>维修统计</h2>
  <div class="toolbar">
    <label>统计时间范围：</label>
    <input type="date" id="statsStart"> 至 <input type="date" id="statsEnd">
    <button onclick="loadStats()">刷新统计</button>
  </div>
  <div id="statsInfo" style="font-size: 14px; color:#333;">暂无统计</div>
</div>

<div class="card">
  <h2>设备选择器（搜索）</h2>
  <div class="toolbar">
    <label>关键词：</label>
    <input type="text" id="equipSearchKeyword" placeholder="输入设备名称/品牌/型号/资产编号等关键词" style="width:260px;">
    <button onclick="searchEquip()">搜索设备</button>
  </div>
  <div id="equipResults" style="margin-top:8px;"></div>
  <div id="selectedEquipBox" style="margin-top:10px; display:none;">
    <strong>已选设备：</strong>
    <span id="selectedEquipInfo"></span>
    <button style="margin-left:8px;" onclick="clearSelectedEquip()">清除选择</button>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" onclick="fillStartFromSelected()">填充到“开始维修”设备ID</button>
      <button type="button" onclick="fillCompleteFromSelected()">填充到“完成维修”设备ID</button>
      <button type="button" onclick="fillFilterFromSelected()">填充到筛选的设备ID</button>
    </div>
    <div style="margin-top:6px; font-size:12px; color:#888;">提示：每次展示前 10 条匹配结果，建议输入更精确的关键词。</div>
  </div>
</div>

<div class="card">
  <h2>维修记录列表</h2>
  <div class="toolbar">
    <label>设备ID：</label>
    <input type="number" id="filterEquipmentId" style="width:120px;">
    <button type="button" onclick="fillFilterFromSelected()">使用已选设备</button>
    <label>仅进行中：</label>
    <input type="checkbox" id="filterOngoingOnly">
    <label>开始时间：</label>
    <input type="date" id="filterStartFrom"> 至 <input type="date" id="filterStartTo">
    <button onclick="applyFilters()">应用筛选</button>
    <button onclick="clearFilters()">清空筛选</button>
    <span style="margin-left:auto; display:flex; align-items:center; gap:6px;">
      <label style="font-size:12px;">每页</label>
      <select id="pageSize" onchange="onPageSizeChanged()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
      <button onclick="prevPage()">上一页</button>
      <button onclick="nextPage()">下一页</button>
      <span id="pageInfo" style="font-size:12px; color:#666;">第 1/1 页，共 0 条</span>
    </span>
  </div>

  <table id="maintTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>设备ID</th>
        <th>设备名称</th>
        <th>描述</th>
        <th>开始时间</th>
        <th>开始操作者</th>
        <th>结束时间</th>
        <th>完成人</th>
        <th>结果</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h2>开始维修</h2>
  <form id="startForm" onsubmit="return submitStart(event)">
    <div class="form-grid">
      <div class="form-item">
        <label>设备ID（必填）</label>
        <input type="number" id="startEquipmentId" required>
        <div style="margin-top:6px;"><button type="button" onclick="fillStartFromSelected()">使用已选设备</button></div>
      </div>
      <div class="form-item" style="grid-column: span 2;">
        <label>维修描述（必填）</label>
        <input type="text" id="startDescription" required placeholder="例如：风扇异常，检测更换">
      </div>
    </div>
    <div class="actions">
      <button type="submit">开始维修</button>
    </div>
    <div id="startMsg" class="hidden"></div>
    <div style="margin-top:8px; font-size:12px; color:#888;">接口：POST /api/equipment/{id}/workflow/maintenance/start（MaintenanceStartDTO: { description }）</div>
  </form>
</div>

<div class="card">
  <h2>完成维修</h2>
  <form id="completeForm" onsubmit="return submitComplete(event)">
    <div class="form-grid">
      <div class="form-item">
        <label>设备ID（必填）</label>
        <input type="number" id="completeEquipmentId" required>
        <div style="margin-top:6px;"><button type="button" onclick="fillCompleteFromSelected()">使用已选设备</button></div>
      </div>
      <div class="form-item" style="grid-column: span 2;">
        <label>维修结果（必填）</label>
        <input type="text" id="completeResult" required placeholder="例如：已更换风扇，恢复正常">
      </div>
    </div>
    <div class="actions">
      <button type="submit">完成维修</button>
    </div>
    <div id="completeMsg" class="hidden"></div>
    <div style="margin-top:8px; font-size:12px; color:#888;">接口：POST /api/equipment/{id}/workflow/maintenance/complete（MaintenanceCompleteDTO: { result }）</div>
  </form>
</div>

<script>
const API_BASE = '/api';
let currentPage = 0;
let totalPages = 1;
const equipNameCache = new Map();
let lastEquipSearchResults = [];
let selectedEquip = null;

function showMsg(text, ok = true) {
  const el = document.getElementById('msg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 4000);
}

function setStartMsg(text, ok = true) {
  const el = document.getElementById('startMsg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5000);
}

function setCompleteMsg(text, ok = true) {
  const el = document.getElementById('completeMsg');
  el.className = ok ? 'success' : 'error';
  el.textContent = text;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5000);
}

async function fetchJson(url, options = {}) {
  const resp = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`HTTP ${resp.status}: ${txt}`);
  }
  const ct = resp.headers.get('content-type') || '';
  if (ct.includes('application/json')) return resp.json();
  return resp.text();
}

// 操作日志缓存与查询（用于显示操作者）
const latestOpCache = new Map(); // key: `${type}:${id}:${action||''}`
async function fetchLatestOperationLog(entityType, entityId, action) {
  const key = `${entityType}:${entityId}:${action || ''}`;
  if (latestOpCache.has(key)) return latestOpCache.get(key);
  try {
    const params = new URLSearchParams();
    params.set('entityType', entityType);
    params.set('entityId', String(entityId));
    if (action) params.set('action', action);
    const log = await fetchJson(`${API_BASE}/operation-logs/latest?` + params.toString());
    latestOpCache.set(key, log || null);
    return log || null;
  } catch (err) {
    // 缓存空，避免重复请求
    latestOpCache.set(key, null);
    return null;
  }
}

// 设备选择器：搜索与选择
async function searchEquip() {
  const keyword = document.getElementById('equipSearchKeyword').value.trim();
  const container = document.getElementById('equipResults');
  if (!keyword) { container.innerHTML = '<div class="error">请输入关键词再搜索</div>'; return; }
  container.innerHTML = '<div>正在搜索...</div>';
  try {
    const page = await fetchJson(`${API_BASE}/equipment/query?keyword=${encodeURIComponent(keyword)}&page=0&size=10`);
    lastEquipSearchResults = (page && page.content) ? page.content : [];
    renderEquipResults();
  } catch (err) {
    container.innerHTML = `<div class="error">搜索设备失败：${err.message}</div>`;
  }
}

function renderEquipResults() {
  const container = document.getElementById('equipResults');
  if (!lastEquipSearchResults.length) { container.innerHTML = '<div class="success">未找到匹配设备，请更换关键词</div>'; return; }
  const html = lastEquipSearchResults.map(item => {
    const id = item.id;
    const name = item.name || '';
    const status = item.status || '';
    const brand = item.brand || '';
    const model = item.model || '';
    const assetNumber = item.assetNumber || '';
    const keeperName = item.keeper && item.keeper.displayName ? item.keeper.displayName : (item.keeper && item.keeper.username ? item.keeper.username : '');
    return `
      <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee;">
        <div>
          <div><strong>${name}</strong>（ID: ${id}）</div>
          <div style="font-size:12px; color:#666;">状态：${status}；品牌：${brand}；型号：${model}；资产编号：${assetNumber}；保管人：${keeperName}</div>
        </div>
        <div>
          <button type="button" onclick="chooseEquip(${id})">选择</button>
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = html;
}

function chooseEquip(id) {
  const found = lastEquipSearchResults.find(x => x.id === id);
  if (!found) return;
  selectedEquip = found;
  const info = `${found.name || ''}（ID: ${found.id}，状态：${found.status || ''}，资产编号：${found.assetNumber || ''}，型号：${found.model || ''}，品牌：${found.brand || ''}）`;
  document.getElementById('selectedEquipInfo').textContent = info;
  document.getElementById('selectedEquipBox').style.display = 'block';
}

function clearSelectedEquip() {
  selectedEquip = null;
  document.getElementById('selectedEquipInfo').textContent = '';
  document.getElementById('selectedEquipBox').style.display = 'none';
}

function fillStartFromSelected() {
  if (!selectedEquip) { alert('请先在上方搜索并选择设备'); return; }
  document.getElementById('startEquipmentId').value = selectedEquip.id;
}

function fillCompleteFromSelected() {
  if (!selectedEquip) { alert('请先在上方搜索并选择设备'); return; }
  document.getElementById('completeEquipmentId').value = selectedEquip.id;
}

function fillFilterFromSelected() {
  if (!selectedEquip) { alert('请先在上方搜索并选择设备'); return; }
  document.getElementById('filterEquipmentId').value = selectedEquip.id;
}

function toDateTimeLocal(dateStr) {
  if (!dateStr) return '';
  try { return new Date(dateStr).toLocaleString(); } catch(e) { return dateStr; }
}

async function getEquipName(id) {
  if (!id) return '';
  if (equipNameCache.has(id)) return equipNameCache.get(id);
  try {
    const e = await fetchJson(`${API_BASE}/equipment/${id}`);
    const name = e && e.name ? e.name : id;
    equipNameCache.set(id, name);
    return name;
  } catch (err) {
    equipNameCache.set(id, String(id));
    return String(id);
  }
}

async function loadStats() {
  try {
    const s = document.getElementById('statsStart').value;
    const e = document.getElementById('statsEnd').value;
    let url = `${API_BASE}/maintenances/stats`;
    if (s && e) {
      const start = new Date(s).toISOString();
      const end = new Date(e).toISOString();
      url += `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    }
    const data = await fetchJson(url);
    document.getElementById('statsInfo').textContent = `进行中：${data.ongoing}，完成数：${data.completed}，平均维修时长：${data.averageDurationHours ?? 0} 小时`;
  } catch (err) {
    showMsg('统计加载失败：' + err.message, false);
  }
}

function buildFilterQuery(page = 0, size = 10) {
  const params = new URLSearchParams();
  const eq = document.getElementById('filterEquipmentId').value;
  const only = document.getElementById('filterOngoingOnly').checked;
  const s = document.getElementById('filterStartFrom').value;
  const t = document.getElementById('filterStartTo').value;
  if (eq) params.append('equipmentId', eq);
  if (only) params.append('ongoingOnly', 'true');
  if (s) params.append('startFrom', new Date(s).toISOString());
  if (t) params.append('startTo', new Date(t).toISOString());
  params.append('page', page);
  params.append('size', size);
  return params.toString();
}

async function loadList() {
  try {
    const size = Number(document.getElementById('pageSize').value);
    const q = buildFilterQuery(currentPage, size);
    const page = await fetchJson(`${API_BASE}/maintenances?${q}`);
    totalPages = page.totalPages ?? 1;
    document.getElementById('pageInfo').textContent = `第 ${page.number + 1}/${totalPages} 页，共 ${page.totalElements} 条`;
    renderTable(page.content || []);
  } catch (err) {
    showMsg('列表加载失败：' + err.message, false);
  }
}

async function renderTable(list) {
  const tbody = document.querySelector('#maintTable tbody');
  tbody.innerHTML = '';
  for (const r of list) {
    const tr = document.createElement('tr');
    const equipName = await getEquipName(r.equipmentId);
    // 查询开始与完成操作者
    const startLog = await fetchLatestOperationLog('MaintenanceRecord', r.id, 'START');
    const completeLog = await fetchLatestOperationLog('MaintenanceRecord', r.id, 'COMPLETE');
    const startActor = startLog && startLog.actor ? startLog.actor : '';
    const completeActor = completeLog && completeLog.actor ? completeLog.actor : '';
    tr.innerHTML = `
      <td>${r.id ?? ''}</td>
      <td>${r.equipmentId ?? ''}</td>
      <td>${equipName}</td>
      <td>${r.description ?? ''}</td>
      <td>${toDateTimeLocal(r.startAt)}</td>
      <td>${startActor}</td>
      <td>${r.endAt ? toDateTimeLocal(r.endAt) : ''}</td>
      <td>${completeActor}</td>
      <td>${r.result ?? ''}</td>
      <td>
        ${!r.endAt ? `<button onclick="completeRow(${r.equipmentId})">完成维修</button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function applyFilters() {
  currentPage = 0;
  loadList();
}

function clearFilters() {
  document.getElementById('filterEquipmentId').value = '';
  document.getElementById('filterOngoingOnly').checked = false;
  document.getElementById('filterStartFrom').value = '';
  document.getElementById('filterStartTo').value = '';
  currentPage = 0;
  loadList();
}

function onPageSizeChanged() {
  currentPage = 0;
  loadList();
}

function prevPage() {
  if (currentPage > 0) {
    currentPage--;
    loadList();
  }
}

function nextPage() {
  if (currentPage + 1 < totalPages) {
    currentPage++;
    loadList();
  }
}

async function submitStart(e) {
  e.preventDefault();
  const id = Number(document.getElementById('startEquipmentId').value);
  const description = document.getElementById('startDescription').value.trim();
  if (!id || !description) { setStartMsg('请填写设备ID与描述', false); return false; }
  try {
    await fetchJson(`${API_BASE}/equipment/${id}/workflow/maintenance/start`, {
      method: 'POST',
      body: JSON.stringify({ description })
    });
    setStartMsg('开始维修成功');
    loadList();
    return false;
  } catch (err) {
    setStartMsg('开始维修失败：' + err.message, false);
    return false;
  }
}

async function submitComplete(e) {
  e.preventDefault();
  const id = Number(document.getElementById('completeEquipmentId').value);
  const result = document.getElementById('completeResult').value.trim();
  if (!id || !result) { setCompleteMsg('请填写设备ID与结果', false); return false; }
  try {
    await fetchJson(`${API_BASE}/equipment/${id}/workflow/maintenance/complete`, {
      method: 'POST',
      body: JSON.stringify({ result })
    });
    setCompleteMsg('完成维修成功');
    loadList();
    return false;
  } catch (err) {
    setCompleteMsg('完成维修失败：' + err.message, false);
    return false;
  }
}

async function completeRow(equipmentId) {
  const result = window.prompt('请输入维修完成结果：');
  if (result === null) return; // 用户取消
  if (!result.trim()) { showMsg('结果不能为空', false); return; }
  try {
    await fetchJson(`${API_BASE}/equipment/${equipmentId}/workflow/maintenance/complete`, {
      method: 'POST',
      body: JSON.stringify({ result })
    });
    showMsg('维修已完成');
    loadList();
  } catch (err) {
    showMsg('完成维修失败：' + err.message, false);
  }
}

function reloadAll() {
  loadStats();
  loadList();
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  // 默认统计近30天
  const now = new Date();
  const start = new Date(now.getTime() - 29 * 24 * 3600 * 1000);
  document.getElementById('statsStart').valueAsDate = start;
  document.getElementById('statsEnd').valueAsDate = now;
  reloadAll();
});
</script>
</body>
</html>