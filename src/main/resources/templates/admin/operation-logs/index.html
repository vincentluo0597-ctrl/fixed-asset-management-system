<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>操作日志</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <header class="admin-header">
    <div class="wrap">
      <div class="brand">设备管理系统 · 操作日志</div>
      <nav>
        <a href="/admin">管理首页</a>
        <a href="/admin/users">用户管理</a>
        <a href="/admin/equipment">设备管理</a>
        <a href="/admin/transfers">设备调用</a>
        <a href="/admin/locations">位置管理</a>
        <a href="/admin/categories">分类管理</a>
        <a href="/admin/suppliers">供应商管理</a>
        <a href="/admin/maintenances">维修管理</a>
        <a href="/admin/inventory">盘库</a>
      </nav>
    </div>
  </header>

  <div class="admin-container">
    <div class="card">
      <div class="section-title">筛选</div>
      <div class="filters" style="grid-template-columns: repeat(6, minmax(140px, 1fr));">
        <div class="form-item">
          <label>操作者（包含匹配）</label>
          <input id="fActor" type="text" placeholder="例如：张三">
        </div>
        <div class="form-item">
          <label>实体类型</label>
          <input id="fEntityType" type="text" placeholder="例如：Equipment">
        </div>
        <div class="form-item">
          <label>实体ID</label>
          <input id="fEntityId" type="number" min="0" placeholder="例如：1001">
        </div>
        <div class="form-item">
          <label>动作</label>
          <input id="fAction" type="text" placeholder="CREATE/UPDATE/DELETE/...">
        </div>
        <div class="form-item">
          <label>开始时间</label>
          <input id="fFrom" type="datetime-local">
        </div>
        <div class="form-item">
          <label>结束时间</label>
          <input id="fTo" type="datetime-local">
        </div>
        <div class="form-item" style="grid-column: span 3;">
          <label>详情关键词</label>
          <input id="fKeyword" type="text" placeholder="在 details 中模糊匹配">
        </div>
        <div class="form-item">
          <label>每页</label>
          <select id="pageSize">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="form-item">
          <label>排序字段</label>
          <select id="sortProp">
            <option value="createdAt" selected>时间</option>
            <option value="actor">操作者</option>
            <option value="action">动作</option>
            <option value="entityId">实体ID</option>
          </select>
        </div>
        <div class="form-item">
          <label>方向</label>
          <select id="sortDir">
            <option value="desc" selected>降序</option>
            <option value="asc">升序</option>
          </select>
        </div>
        <div class="form-item">
          <label>&nbsp;</label>
          <div class="page-controls">
            <button class="btn btn-primary" onclick="applyFilters()">查询</button>
            <button class="btn btn-secondary" onclick="clearFilters()">清空</button>
            <button class="btn" onclick="exportCsv()">导出 CSV</button>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">接口：GET /api/operation-logs/page（actor/entityType/entityId/action/from/to/keyword/page/size/sort）；导出：GET /api/operation-logs/export（支持同样筛选参数）</div>
    </div>

    <div class="card">
      <div class="section-title">操作日志列表</div>
      <div class="toolbar" style="display:flex; gap:8px; flex-wrap: wrap; margin: 6px 0 10px 0; align-items:center;">
        <span class="muted">快捷筛选：</span>
        <button class="btn btn-secondary" onclick="quickAction('CREATE')">仅 CREATE</button>
        <button class="btn btn-secondary" onclick="quickAction('UPDATE')">仅 UPDATE</button>
        <button class="btn btn-secondary" onclick="quickAction('DELETE')">仅 DELETE</button>
        <span class="muted" style="margin-left: 8px;">时间：</span>
        <button class="btn" onclick="quickTime('24h')">最近 24 小时</button>
        <button class="btn" onclick="quickTime('7d')">最近 7 天</button>
        <button class="btn" onclick="resetQuick()">重置</button>
      </div>
      <table id="logTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>时间</th>
            <th>操作者</th>
            <th>实体类型</th>
            <th>实体ID</th>
            <th>动作</th>
            <th>详情</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="page-controls" style="margin-top:10px;">
        <button class="btn" onclick="prevPage()">上一页</button>
        <button class="btn" onclick="nextPage()">下一页</button>
        <span id="pageInfo" class="page-info">第 1/1 页，共 0 条</span>
      </div>
    </div>
  </div>

  <!-- 详情弹窗（覆盖层） -->
  <div id="detailOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999;">
    <div class="card" style="background:#fff; width:90%; max-width:900px;">
      <div class="section-title">日志详情</div>
      <div style="padding: 8px 12px;">
        <div style="display:grid; grid-template-columns: 160px 1fr; gap:8px; align-items:center;">
          <div class="muted">时间</div>
          <div id="detailCreatedAt"></div>
          <div class="muted">操作者</div>
          <div id="detailActor"></div>
          <div class="muted">动作</div>
          <div id="detailAction"></div>
          <div class="muted">实体类型</div>
          <div id="detailEntityType"></div>
          <div class="muted">实体ID</div>
          <div id="detailEntityId"></div>
        </div>
        <div style="margin-top:10px;">
          <div class="muted">详情</div>
          <pre id="detailText" style="white-space:pre-wrap; word-break:break-word; background:#f5f7fa; padding:10px; border-radius:6px; border:1px solid #eaecef; max-height:40vh; overflow:auto;"></pre>
        </div>
      </div>
      <div class="page-controls" style="padding: 0 12px 12px 12px;">
        <button class="btn" onclick="copyDetails()">复制详情</button>
        <button class="btn btn-secondary" onclick="closeDetail()">关闭</button>
      </div>
    </div>
  </div>

<script>
const API_BASE = '/api/operation-logs';
let currentPage = 0;
let totalPages = 1;
let totalElements = 0;
let lastLogs = [];

function toIsoLocal(dtStr) {
  // datetime-local -> ISO 8601（不含秒则补 00）
  if (!dtStr) return '';
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dtStr)) return dtStr + ':00';
  return dtStr; // 浏览器若已包含秒
}

function buildParams(page = 0) {
  const p = new URLSearchParams();
  const actor = document.getElementById('fActor').value.trim();
  const entityType = document.getElementById('fEntityType').value.trim();
  const entityIdStr = document.getElementById('fEntityId').value.trim();
  const action = document.getElementById('fAction').value.trim();
  const from = toIsoLocal(document.getElementById('fFrom').value);
  const to = toIsoLocal(document.getElementById('fTo').value);
  const keyword = document.getElementById('fKeyword').value.trim();
  const size = parseInt(document.getElementById('pageSize').value, 10) || 20;
  const sortPropEl = document.getElementById('sortProp');
  const sortDirEl = document.getElementById('sortDir');
  const sortProp = sortPropEl ? sortPropEl.value : 'createdAt';
  const sortDir = sortDirEl ? sortDirEl.value : 'desc';
  if (actor) p.set('actor', actor);
  if (entityType) p.set('entityType', entityType);
  if (entityIdStr) p.set('entityId', entityIdStr);
  if (action) p.set('action', action);
  if (from) p.set('from', from);
  if (to) p.set('to', to);
  if (keyword) p.set('keyword', keyword);
  p.set('page', String(page));
  p.set('size', String(size));
  p.set('sort', `${sortProp},${sortDir}`);
  return p;
}

async function fetchJson(url) {
  const resp = await fetch(url);
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`HTTP ${resp.status}: ${txt}`);
  }
  const ct = resp.headers.get('content-type') || '';
  if (ct.includes('application/json')) return resp.json();
  return resp.text();
}

function fmtTime(s) {
  if (!s) return '';
  // 期望形如 2025-01-01T12:34:56
  const d = new Date(s);
  if (isNaN(d.getTime())) return s;
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

async function loadPage(page = 0) {
  const params = buildParams(page);
  const url = `${API_BASE}/page?${params.toString()}`;
  try {
    const data = await fetchJson(url);
    const tbody = document.querySelector('#logTable tbody');
    tbody.innerHTML = '';
    const rows = (data && data.content) ? data.content : [];
    totalPages = (data && typeof data.totalPages === 'number') ? data.totalPages : 1;
    totalElements = (data && typeof data.totalElements === 'number') ? data.totalElements : rows.length;
    currentPage = (data && typeof data.number === 'number') ? data.number : page;
    lastLogs = rows;
    const html = rows.map((item, i) => {
      const id = item.id ?? '';
      const actor = item.actor ?? '';
      const entityType = item.entityType ?? '';
      const entityId = (item.entityId == null ? '' : item.entityId);
      const action = item.action ?? '';
      const details = item.details ?? '';
      const createdAt = fmtTime(item.createdAt);
      return `<tr>
        <td>${id}</td>
        <td>${createdAt}</td>
        <td>${actor}</td>
        <td>${entityType}</td>
        <td>${entityId}</td>
        <td>${action}</td>
        <td>${details}</td>
        <td><button class="btn btn-secondary" onclick="openDetail(${i})">查看</button></td>
      </tr>`;
    }).join('');
    tbody.innerHTML = html;
    document.getElementById('pageInfo').textContent = `第 ${currentPage+1}/${Math.max(totalPages,1)} 页，共 ${totalElements} 条`;
  } catch (err) {
    alert('加载日志失败：' + err.message);
  }
}

function applyFilters() { loadPage(0); }
function clearFilters() {
  ['fActor','fEntityType','fEntityId','fAction','fFrom','fTo','fKeyword'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  loadPage(0);
}

// 快捷筛选
function toLocalDtStr(date) {
  const pad = n => String(n).padStart(2, '0');
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
}
function quickAction(action) {
  const el = document.getElementById('fAction');
  if (el) el.value = action;
  loadPage(0);
}
function quickTime(range) {
  const now = new Date();
  let from = now;
  if (range === '24h') from = new Date(now.getTime() - 24*3600*1000);
  if (range === '7d') from = new Date(now.getTime() - 7*24*3600*1000);
  const fEl = document.getElementById('fFrom');
  const tEl = document.getElementById('fTo');
  if (fEl) fEl.value = toLocalDtStr(from);
  if (tEl) tEl.value = toLocalDtStr(now);
  loadPage(0);
}
function resetQuick() {
  ['fAction','fFrom','fTo'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  loadPage(0);
}
function prevPage() { if (currentPage > 0) loadPage(currentPage - 1); }
function nextPage() { if (currentPage < totalPages - 1) loadPage(currentPage + 1); }

function exportCsv() {
  const params = buildParams();
  // 导出接口无需 page/size
  params.delete('page');
  params.delete('size');
  const url = `${API_BASE}/export?${params.toString()}`;
  window.open(url, '_blank');
}

function openDetail(i) {
  const overlay = document.getElementById('detailOverlay');
  const item = lastLogs[i];
  if (!overlay || !item) return;
  const createdAt = fmtTime(item.createdAt);
  document.getElementById('detailCreatedAt').textContent = createdAt;
  document.getElementById('detailActor').textContent = item.actor ?? '';
  document.getElementById('detailAction').textContent = item.action ?? '';
  document.getElementById('detailEntityType').textContent = item.entityType ?? '';
  document.getElementById('detailEntityId').textContent = (item.entityId == null ? '' : item.entityId);
  const detailsText = item.details ?? '';
  document.getElementById('detailText').textContent = detailsText;
  overlay.classList.remove('hidden');
  window._currentDetailText = `时间：${createdAt}\n操作者：${item.actor ?? ''}\n动作：${item.action ?? ''}\n实体类型：${item.entityType ?? ''}\n实体ID：${item.entityId == null ? '' : item.entityId}\n详情：\n${detailsText}`;
}
function closeDetail() {
  const overlay = document.getElementById('detailOverlay');
  if (overlay) overlay.classList.add('hidden');
  window._currentDetailText = '';
}
async function copyDetails() {
  const txt = window._currentDetailText || (document.getElementById('detailText')?.textContent || '');
  try {
    await navigator.clipboard.writeText(txt);
    alert('已复制到剪贴板');
  } catch (e) {
    alert('复制失败：' + e.message);
  }
}

// 初始化
loadPage(0);
</script>
</body>
</html>