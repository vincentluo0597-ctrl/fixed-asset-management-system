<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 智能资产管理系统</title>
    <link rel="stylesheet" href="/css/modern-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 用户管理特定样式 */
        .users-header {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            padding: var(--space-6) var(--space-8);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }

        .users-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        .users-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-2);
            position: relative;
            z-index: 1;
        }

        .users-subtitle {
            font-size: var(--font-size-lg);
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-top: var(--space-1);
        }

        .create-user-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--space-6);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .form-group label {
            font-weight: var(--font-weight-medium);
            color: var(--gray-700);
            font-size: var(--font-size-sm);
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--danger-500);
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .role-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .role-checkbox:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
        }

        .role-checkbox input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        .role-admin {
            border-left: 3px solid var(--danger-500);
        }

        .role-maintainer {
            border-left: 3px solid var(--warning-500);
        }

        .role-viewer {
            border-left: 3px solid var(--success-500);
        }

        .users-table-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .users-table th {
            background: var(--gray-50);
            color: var(--gray-700);
            font-weight: var(--font-weight-semibold);
            text-align: left;
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .users-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .users-table tbody tr {
            transition: all var(--transition-fast);
        }

        .users-table tbody tr:hover {
            background: var(--gray-50);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: var(--space-1);
            margin-bottom: var(--space-1);
        }

        .role-badge-admin {
            background: var(--danger-50);
            color: var(--danger-700);
            border: 1px solid var(--danger-200);
        }

        .role-badge-maintainer {
            background: var(--warning-50);
            color: var(--warning-700);
            border: 1px solid var(--warning-200);
        }

        .role-badge-viewer {
            background: var(--success-50);
            color: var(--success-700);
            border: 1px solid var(--success-200);
        }

        .action-buttons-cell {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .btn-icon-sm {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-icon-primary {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .btn-icon-primary:hover {
            background: var(--primary-200);
            transform: scale(1.1);
        }

        .btn-icon-danger {
            background: var(--danger-100);
            color: var(--danger-600);
        }

        .btn-icon-danger:hover {
            background: var(--danger-200);
            transform: scale(1.1);
        }

        .edit-form-row {
            background: var(--primary-50);
            border: 2px solid var(--primary-200);
            border-radius: var(--radius-lg);
        }

        .edit-form-row td {
            padding: var(--space-6);
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .user-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .users-table {
                font-size: var(--font-size-xs);
            }
            
            .users-table th,
            .users-table td {
                padding: var(--space-2) var(--space-3);
            }
            
            .action-buttons-cell {
                flex-direction: column;
            }
            
            .roles-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .user-stats {
                grid-template-columns: 1fr;
            }
        }

        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- 现代化导航栏 -->
    <nav class="modern-nav">
        <div class="modern-flex-between">
            <a href="/admin" class="modern-nav-brand">
                <i class="fas fa-desktop"></i>
                资产管理系统
            </a>
            <ul class="modern-nav-menu">
                <li><a href="/admin" class="modern-nav-link">仪表板</a></li>
                <li><a href="/admin/users" class="modern-nav-link active">用户管理</a></li>
                <li><a href="/admin/equipment" class="modern-nav-link">设备管理</a></li>
                <li><a href="/admin/transfers" class="modern-nav-link">设备调用</a></li>
                <li><a href="/admin/locations" class="modern-nav-link">位置管理</a></li>
                <li><a href="/admin/categories" class="modern-nav-link">分类管理</a></li>
                <li><a href="/admin/suppliers" class="modern-nav-link">供应商管理</a></li>
                <li><a href="/logout" class="modern-nav-link">退出登录</a></li>
            </ul>
        </div>
    </nav>

    <div class="modern-container">
        <!-- 页面头部 -->
        <div class="users-header fade-in">
            <h1 class="users-title">
                <i class="fas fa-users"></i>
                用户管理
            </h1>
            <p class="users-subtitle">管理系统用户，分配角色权限，保障系统安全</p>
        </div>

        <!-- 统计概览 -->
        <div class="user-stats fade-in">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-100); color: var(--primary-600);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">用户总数</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--danger-100); color: var(--danger-600);">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="adminUsers">-</div>
                    <div class="stat-label">管理员用户</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--warning-100); color: var(--warning-600);">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="maintainerUsers">-</div>
                    <div class="stat-label">维护人员</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--success-100); color: var(--success-600);">
                    <i class="fas fa-user"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="viewerUsers">-</div>
                    <div class="stat-label">普通用户</div>
                </div>
            </div>
        </div>

        <!-- 操作栏 -->
        <div class="action-bar fade-in">
            <div class="action-buttons">
                <button class="modern-btn modern-btn-primary" onclick="reloadPage(0)">
                    <i class="fas fa-sync-alt"></i>
                    刷新数据
                </button>
                <button class="modern-btn modern-btn-outline" onclick="exportUsers()">
                    <i class="fas fa-download"></i>
                    导出用户
                </button>
            </div>
            <div class="modern-input-group" style="max-width: 300px;">
                <input type="text" id="quickSearch" class="modern-input" placeholder="搜索用户名或显示名..." onkeyup="onQuickSearch(event)">
                <button class="modern-btn modern-btn-primary" onclick="onSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="msg" class="modern-alert hidden"></div>

        <!-- 创建用户表单 -->
        <div class="create-user-card fade-in">
            <div class="modern-card-header">
                <h3><i class="fas fa-user-plus"></i> 创建新用户</h3>
                <button type="button" class="modern-btn modern-btn-sm modern-btn-outline" onclick="resetCreateForm()">
                    <i class="fas fa-undo"></i>
                    重置
                </button>
            </div>
            <form id="createForm" onsubmit="return submitCreate(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="required">用户名</label>
                        <input type="text" id="c_username" class="modern-input" required placeholder="请输入用户名">
                    </div>
                    <div class="form-group">
                        <label>显示名称</label>
                        <input type="text" id="c_displayName" class="modern-input" placeholder="可选，用于显示">
                    </div>
                    <div class="form-group">
                        <label class="required">密码</label>
                        <input type="password" id="c_password" class="modern-input" required placeholder="请输入密码">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="required">用户角色</label>
                        <div class="roles-grid">
                            <label class="role-checkbox role-admin">
                                <input type="checkbox" name="c_roles" value="ADMIN">
                                <span><i class="fas fa-user-shield"></i> 管理员</span>
                            </label>
                            <label class="role-checkbox role-maintainer">
                                <input type="checkbox" name="c_roles" value="MAINTAINER">
                                <span><i class="fas fa-user-cog"></i> 维护人员</span>
                            </label>
                            <label class="role-checkbox role-viewer">
                                <input type="checkbox" name="c_roles" value="VIEWER">
                                <span><i class="fas fa-user"></i> 普通用户</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modern-flex" style="gap: var(--space-3); margin-top: var(--space-4);">
                    <button type="submit" class="modern-btn modern-btn-success">
                        <i class="fas fa-save"></i>
                        创建用户
                    </button>
                    <button type="reset" class="modern-btn modern-btn-secondary">
                        <i class="fas fa-undo"></i>
                        重置表单
                    </button>
                </div>
            </form>
            <div id="createMsg" class="modern-alert hidden"></div>
        </div>

        <!-- 用户列表 -->
        <div class="users-table-container fade-in">
            <div class="modern-card-header">
                <h3><i class="fas fa-list"></i> 用户列表</h3>
                <div class="modern-flex" style="gap: var(--space-2);">
                    <div class="modern-input-group" style="margin: 0;">
                        <label style="margin: 0; white-space: nowrap;">每页显示</label>
                        <select id="pageSize" class="modern-select" onchange="reloadPage(0)" style="min-width: 80px;">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
            <table id="userTable" class="users-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>用户名</th>
                        <th>显示名称</th>
                        <th>角色</th>
                        <th style="width: 180px;">创建时间</th>
                        <th style="width: 200px;">操作</th>
                    </tr>
                </thead>
                <tbody id="userTbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
                            <i class="fas fa-spinner fa-spin" style="font-size: var(--font-size-2xl); margin-bottom: var(--space-4);"></i>
                            <div>正在加载用户数据...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="modern-pagination" id="paginationContainer">
            <div class="pagination-info">
                <span id="pageInfo">第 1/1 页，共 0 条</span>
            </div>
            <div class="pagination-controls">
                <button id="prevBtn" class="modern-btn modern-btn-sm" onclick="prevPage()">
                    <i class="fas fa-chevron-left"></i>
                    上一页
                </button>
                <button id="nextBtn" class="modern-btn modern-btn-sm" onclick="nextPage()">
                    下一页
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        let currentPage = 0;
        let pageSize = 20;
        let totalPages = 0;
        let totalElements = 0;
        let searchKeyword = '';

        // 显示消息
        function showMsg(text, type = 'success') {
            const msgEl = document.getElementById('msg');
            msgEl.textContent = text;
            msgEl.className = `modern-alert modern-alert-${type}`;
            msgEl.classList.remove('hidden');
            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 4000);
        }

        function setCreateMsg(text, type = 'success') {
            const msgEl = document.getElementById('createMsg');
            msgEl.textContent = text;
            msgEl.className = `modern-alert modern-alert-${type}`;
            msgEl.classList.remove('hidden');
            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 5000);
        }

        // API请求
        async function fetchJson(url, options = {}) {
            const resp = await fetch(url, { 
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }, 
                ...options 
            });
            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(`HTTP ${resp.status}: ${txt}`);
            }
            return resp.json();
        }

        // 角色徽章样式
        function getRoleBadge(role) {
            const badges = {
                'ADMIN': '<span class="role-badge role-badge-admin"><i class="fas fa-user-shield"></i> 管理员</span>',
                'MAINTAINER': '<span class="role-badge role-badge-maintainer"><i class="fas fa-user-cog"></i> 维护人员</span>',
                'VIEWER': '<span class="role-badge role-badge-viewer"><i class="fas fa-user"></i> 普通用户</span>'
            };
            return badges[role] || `<span class="role-badge">${role}</span>`;
        }

        // 渲染用户表格
        function renderUserTable(users) {
            const tbody = document.getElementById('userTbody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
                            <i class="fas fa-users" style="font-size: var(--font-size-3xl); margin-bottom: var(--space-4);"></i>
                            <div>暂无用户数据</div>
                            <div style="font-size: var(--font-size-sm); margin-top: var(--space-2);">点击上方"创建用户"按钮添加第一个用户</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                const rolesHtml = user.roles && user.roles.length > 0 
                    ? user.roles.map(role => getRoleBadge(role)).join('') 
                    : '<span class="modern-badge modern-badge-outline">无角色</span>';
                
                tr.innerHTML = `
                    <td><span class="modern-badge modern-badge-primary">${user.id}</span></td>
                    <td><strong>${escapeHtml(user.username)}</strong></td>
                    <td>${escapeHtml(user.displayName || '-')}</td>
                    <td>${rolesHtml}</td>
                    <td><small>${user.createdAt ? new Date(user.createdAt).toLocaleString() : '-'}</small></td>
                    <td>
                        <div class="action-buttons-cell">
                            <button class="btn-icon-sm btn-icon-primary" onclick="openEditForm(${user.id}, '${encodeURIComponent(user.displayName || '')}')" title="编辑用户">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon-sm btn-icon-danger" onclick="deleteUser(${user.id})" title="删除用户">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const users = await fetchJson(`${API_BASE}/admin/users`);
                const total = users.length;
                const admin = users.filter(u => u.roles && u.roles.includes('ADMIN')).length;
                const maintainer = users.filter(u => u.roles && u.roles.includes('MAINTAINER')).length;
                const viewer = users.filter(u => u.roles && u.roles.includes('VIEWER')).length;

                // 动画更新数字
                animateNumber('totalUsers', total);
                animateNumber('adminUsers', admin);
                animateNumber('maintainerUsers', maintainer);
                animateNumber('viewerUsers', viewer);

            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 数字动画
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            const duration = 1000;
            const startTime = performance.now();

            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // 加载用户列表
        async function reloadPage(page) {
            try {
                pageSize = parseInt(document.getElementById('pageSize').value) || 20;
                
                let url = `${API_BASE}/admin/users/page?page=${page}&size=${pageSize}`;
                if (searchKeyword) {
                    url += `&keyword=${encodeURIComponent(searchKeyword)}`;
                }
                
                const data = await fetchJson(url);
                const users = data.content || [];
                
                currentPage = data.number || page;
                totalPages = data.totalPages || 1;
                totalElements = data.totalElements || users.length;

                renderUserTable(users);
                updatePageInfo();
                loadStats();
                
                showMsg('用户数据加载成功', 'success');
                
            } catch (err) {
                console.error(err);
                showMsg(`加载用户失败：${err.message}`, 'error');
            }
        }

        // 更新分页信息
        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `第 ${Math.min(currentPage + 1, Math.max(totalPages, 1))}/${Math.max(totalPages, 1)} 页，共 ${totalElements} 条`;

            // 更新按钮状态
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
        }

        // 搜索功能
        function onQuickSearch(event) {
            if (event.key === 'Enter') {
                onSearch();
            }
        }

        function onSearch() {
            searchKeyword = document.getElementById('quickSearch').value.trim();
            currentPage = 0;
            reloadPage(currentPage);
        }

        // 分页功能
        function prevPage() {
            if (currentPage > 0) {
                currentPage -= 1;
                reloadPage(currentPage);
            }
        }

        function nextPage() {
            if (currentPage < totalPages - 1) {
                currentPage += 1;
                reloadPage(currentPage);
            }
        }

        // 表单提交
        async function submitCreate(event) {
            event.preventDefault();
            
            const username = document.getElementById('c_username').value.trim();
            const displayName = document.getElementById('c_displayName').value.trim();
            const password = document.getElementById('c_password').value;
            const roles = Array.from(document.querySelectorAll("input[name='c_roles']:checked")).map(i => i.value);
            
            if (!username) {
                setCreateMsg('用户名不能为空', 'error');
                return;
            }
            if (!password) {
                setCreateMsg('密码不能为空', 'error');
                return;
            }
            if (roles.length === 0) {
                setCreateMsg('至少选择一个用户角色', 'error');
                return;
            }

            try {
                const payload = {
                    username: username,
                    displayName: displayName || null,
                    password: password,
                    roles: roles
                };
                
                const created = await fetchJson(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                setCreateMsg(`用户创建成功：${created.username} (ID=${created.id})`, 'success');
                document.getElementById('createForm').reset();
                reloadPage(0);
                
            } catch (err) {
                console.error(err);
                setCreateMsg(`创建失败：${err.message}`, 'error');
            }
        }

        // 编辑功能
        function openEditForm(id, displayNameEnc) {
            const displayName = decodeURIComponent(displayNameEnc || '');
            const tbody = document.getElementById('userTbody');
            
            // 移除之前的编辑行
            const existingEditRow = document.querySelector('.edit-form-row');
            if (existingEditRow) {
                existingEditRow.remove();
            }
            
            // 创建编辑行
            const editRow = document.createElement('tr');
            editRow.className = 'edit-form-row slide-in';
            editRow.innerHTML = `
                <td colspan="6">
                    <div class="edit-form-grid">
                        <div class="form-group">
                            <label>显示名称</label>
                            <input type="text" id="e_displayName_${id}" class="modern-input" value="${escapeHtml(displayName)}" placeholder="显示名称">
                        </div>
                        <div class="form-group">
                            <label>新密码（可选）</label>
                            <input type="password" id="e_password_${id}" class="modern-input" placeholder="留空则不修改密码">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>用户角色（若设置则覆盖）</label>
                            <div class="roles-grid">
                                <label class="role-checkbox role-admin">
                                    <input type="checkbox" name="e_roles_${id}" value="ADMIN">
                                    <span><i class="fas fa-user-shield"></i> 管理员</span>
                                </label>
                                <label class="role-checkbox role-maintainer">
                                    <input type="checkbox" name="e_roles_${id}" value="MAINTAINER">
                                    <span><i class="fas fa-user-cog"></i> 维护人员</span>
                                </label>
                                <label class="role-checkbox role-viewer">
                                    <input type="checkbox" name="e_roles_${id}" value="VIEWER">
                                    <span><i class="fas fa-user"></i> 普通用户</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modern-flex" style="gap: var(--space-3);">
                        <button class="modern-btn modern-btn-success" onclick="applyEdit(${id})">
                            <i class="fas fa-save"></i>
                            保存更新
                        </button>
                        <button class="modern-btn modern-btn-secondary" onclick="cancelEdit()">
                            <i class="fas fa-times"></i>
                            取消编辑
                        </button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(editRow, tbody.firstChild);
            editRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function applyEdit(id) {
            const displayName = document.getElementById(`e_displayName_${id}`).value.trim();
            const password = document.getElementById(`e_password_${id}`).value;
            const roles = Array.from(document.querySelectorAll(`input[name='e_roles_${id}']:checked`)).map(i => i.value);
            
            const payload = {};
            if (displayName) payload.displayName = displayName;
            if (password) payload.password = password;
            if (roles.length > 0) payload.roles = roles;
            
            if (Object.keys(payload).length === 0) {
                showMsg('没有需要更新的内容', 'warning');
                return;
            }

            try {
                await fetchJson(`${API_BASE}/admin/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                
                showMsg('用户更新成功', 'success');
                cancelEdit();
                reloadPage(currentPage);
                
            } catch (err) {
                console.error(err);
                showMsg(`更新失败：${err.message}`, 'error');
            }
        }

        function cancelEdit() {
            const editRow = document.querySelector('.edit-form-row');
            if (editRow) {
                editRow.remove();
            }
        }

        // 删除功能
        async function deleteUser(id) {
            if (!confirm('确认删除该用户？此操作不可恢复。')) return;
            
            try {
                const resp = await fetch(`${API_BASE}/admin/users/${id}`, { method: 'DELETE' });
                if (!resp.ok && resp.status !== 204) {
                    const txt = await resp.text();
                    throw new Error(`删除失败: ${resp.status} ${txt}`);
                }
                
                showMsg('用户删除成功', 'success');
                reloadPage(currentPage);
                
            } catch (err) {
                console.error(err);
                showMsg(`删除失败：${err.message}`, 'error');
            }
        }

        // 导出功能
        function exportUsers() {
            try {
                const url = `${API_BASE}/admin/users/export`;
                window.open(url, '_blank');
                showMsg('用户数据导出中...', 'info');
            } catch (err) {
                console.error(err);
                showMsg('导出失败：' + err.message, 'error');
            }
        }

        // 表单重置
        function resetCreateForm() {
            document.getElementById('createForm').reset();
            setCreateMsg('表单已重置', 'success');
        }

        // 工具函数
        function escapeHtml(str) {
            return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            reloadPage(0);
            
            // 添加键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    reloadPage(currentPage);
                }
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('c_username').focus();
                }
            });
        });
    </script>
</body>
</html>